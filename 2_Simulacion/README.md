# Controlled Simulation of Transcriptomic and Clinical Data

This folder contains the code and files needed to generate synthetic datasets with a defined causal structure, aimed at analyzing the effect of confounding variables on the performance of Random Forest-based classification models.

---

##  Objectives

- Generate a simulated dataset with full control over the relationships between confounding variables (clinical and technical), gene expression, and diagnosis.
- Evaluate the impact of confounders on the predictive performance of Random Forest models.
- Study how gene importance rankings change depending on model configuration.
- Validate the use of the `always.split.variables` parameter as a tool to control for confounders.

---

## Folder contents

- `generador_simulacion.ipynb`: Python notebook that generates synthetic data with explicit causal structure. It includes the definition of gene groups (A, B, D, Noise) and the binary target variable.
- `generador_simulacion.html`: Rendered version of the Jupyter Notebook.
- `dataset_simulado.csv`: Output dataset generated by the notebook. Includes clinical variables, simulated genes, and binary diagnosis.
- `analisis_simulacion.Rmd`: R Markdown code that trains Random Forest models, performs cross-validation and bootstrapping, evaluates performance, and analyzes variable importance.
- `analisis_simulacion.html`: Rendered version of the above R Markdown file.

---

## Simulator description

The simulator creates a synthetic dataset with the following components:

- **Clinical variables (matrix C)**:
  - `age`: continuous variable (mean = 60; range: 40–85)
  - `sex`: binary, generated from N(0, 1) with threshold at 0
  - `RIN`: continuous technical variable (mean = 6; range: 0–10)
  - `batch`: categorical variable with 4 levels

- **Simulated genes (matrix M)**:
  - Group A: 100 genes correlated with `age` (r ≈ 0.4), internally correlated (0.3–0.6)
  - Group B: 200 genes correlated with `sex` (r ≈ 0.4), internally correlated (0.2–0.4)
  - Group D: 300 genes internally correlated (0.2–0.4), unrelated to confounders
  - Noise group: 400 genes independent of confounders and the target variable

- **Target variable (Y)**:
  - Binary, generated as a combination of genes from groups A and B along with `age` and `sex`

---

## Simulation code (`generador_simulacion.ipynb`)

- Libraries used: **numpy**, **pandas**, **scipy**, **matplotlib**, **seaborn**, **sklearn**, **statsmodels**
- Configurable parameters:
  - Number of individuals
  - Internal and external correlation values for gene groups
  - Number of genes per group
  - Variables and gene groups used to construct the target variable
- Output: `dataset_simulado.csv`

---

## Analysis code (`analisis_simulacion.Rmd`)

1. Data loading, initial exploration, DataFrame creation, and train/test split
2. Training Random Forest models using:
   - Gene expression only (**M**, **AB**, **ABD**)
   - Gene expression + confounders (**MC**, **AB+C**, **ABD+C**)
   - Models forcing confounders via `always.split.variables`
   - Confounders only (**C**)
3. 5-fold cross-validation and 15 bootstraps
4. Evaluation of Balanced Accuracy + 95% CI
5. Variable importance analysis via `varImp`

---

## Results

- Models including covariates (`AB+C`, `ABD+C`) outperformed those using gene expression alone.
- Using `always.split.variables` with `age` significantly improved classification performance.
- Non-informative covariates like `RIN` or `batch` did not improve model performance, even when forced into splits.
- The variable importance analysis confirmed that Random Forest prioritizes informative genes even in the presence of noise.

---

## Reproducibility

To execute the simulation in a Python 3 + Jupyter environment:


```python
jupyter nbconvert --execute generador_simulacion.ipynb
```

```r
rmarkdown::render("analisis_simulacion.Rmd")
```

